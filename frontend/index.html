<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doc Summary Assistant</title>
  <!-- Tailwind via CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Subtle dotted border for dropzone */
    .dropzone { border: 2px dashed rgb(203 213 225); }
    .dropzone.dragover { border-color: rgb(59 130 246); background: #f8fbff; }
    /* Monospace output readability */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
  <header class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-semibold tracking-tight">Doc Summary Assistant</h1>
    <p class="text-slate-500 mt-1">Upload a PDF or image to get a clean summary. Works with <span class="whitespace-nowrap">short · medium · long</span> styles.</p>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-24">
    <!-- Upload Card -->
    <section class="bg-white rounded-2xl shadow p-6">
      <!-- Dropzone -->
      <div id="dropzone" class="dropzone rounded-xl p-8 text-center transition select-none">
        <p class="text-slate-500"><span class="font-medium">Drag & drop</span> PDF/Image here or choose a file</p>
        <input id="fileInput" type="file" class="sr-only" aria-label="Choose file" accept=".pdf,.png,.jpg,.jpeg,.webp,.bmp,.tiff" />
        <div class="mt-4 flex items-center justify-center gap-3">
          <button id="chooseBtn" class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900 active:scale-[.99]">Choose file</button>
          <span id="fileName" class="text-sm text-slate-500"></span>
        </div>
      </div>

      <!-- Options Row -->
      <div class="mt-6 flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-500">Length:</span>
          <div class="inline-flex rounded-xl bg-slate-100 p-1" role="tablist" aria-label="Summary length">
            <button class="lenBtn px-3 py-1.5 rounded-lg text-sm font-medium" data-val="short">Short</button>
            <button class="lenBtn px-3 py-1.5 rounded-lg text-sm font-medium bg-white shadow" data-val="medium" aria-selected="true">Medium</button>
            <button class="lenBtn px-3 py-1.5 rounded-lg text-sm font-medium" data-val="long">Long</button>
          </div>
        </div>
        <div class="grow"></div>
        <button id="summarizeBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 active:scale-[.99]" disabled>Summarize</button>
      </div>

      <!-- Progress -->
      <div id="progressWrap" class="mt-4 hidden">
        <div class="w-full bg-slate-100 rounded-lg overflow-hidden">
          <div id="progressBar" class="h-2 bg-blue-600 w-0"></div>
        </div>
        <p id="progressText" class="text-xs text-slate-500 mt-1">Uploading…</p>
      </div>

      <!-- Error Banner -->
      <div id="errorBox" class="mt-4 hidden rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"></div>

      <!-- Result -->
      <div id="resultCard" class="mt-6 hidden">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-medium">Result</h2>
          <div class="flex items-center gap-2">
            <button id="copyBtn" class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm">Copy</button>
            <button id="downloadBtn" class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm">Download .txt</button>
          </div>
        </div>
        <pre id="summaryOut" class="mono whitespace-pre-wrap bg-slate-50 rounded-xl p-4 border border-slate-200"></pre>
        <div id="metaOut" class="mt-4 hidden">
          <h3 class="text-sm font-medium text-slate-600">Document meta</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mt-2 text-sm">
            <div><span class="text-slate-500">Title:</span> <span id="mTitle" class="font-medium"></span></div>
            <div><span class="text-slate-500">Author:</span> <span id="mAuthor" class="font-medium"></span></div>
            <div><span class="text-slate-500">Subject:</span> <span id="mSubject" class="font-medium"></span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tips -->
    <p class="text-xs text-slate-500 mt-4">Max size 25MB. Allowed: PDF, PNG, JPG, JPEG.</p>
  </main>
    <footer>
    © 2025 Made by <b>Hridayansh Gupta</b>
  </footer>

  <script>
    // ===== Config =====
    const API_URL = "/api/summarize"; // same-origin when served via FastAPI StaticFiles
    const ALLOWED = ["pdf","png","jpg","jpeg","webp","bmp","tiff"]; 
    const MAX_BYTES = 25 * 1024 * 1024; // 25 MB

    // ===== Elements =====
    const dz = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const chooseBtn = document.getElementById('chooseBtn');
    const fileName = document.getElementById('fileName');
    const lenBtns = Array.from(document.querySelectorAll('.lenBtn'));
    const summarizeBtn = document.getElementById('summarizeBtn');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const errorBox = document.getElementById('errorBox');
    const resultCard = document.getElementById('resultCard');
    const summaryOut = document.getElementById('summaryOut');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const metaOut = document.getElementById('metaOut');
    const mTitle = document.getElementById('mTitle');
    const mAuthor = document.getElementById('mAuthor');
    const mSubject = document.getElementById('mSubject');

    let chosenFile = null;
    let lengthVal = 'medium';

    // ===== Helpers =====
    const resetUI = () => {
      errorBox.classList.add('hidden');
      resultCard.classList.add('hidden');
      metaOut.classList.add('hidden');
      summaryOut.textContent = '';
      mTitle.textContent = ''; mAuthor.textContent = ''; mSubject.textContent = '';
    };
    const showError = (msg) => {
      errorBox.textContent = msg;
      errorBox.classList.remove('hidden');
    };
    const validateFile = (file) => {
      if (!file) return 'Please pick a file.';
      if (file.size > MAX_BYTES) return 'File too large. Max 25MB.';
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      if (!ALLOWED.includes(ext)) return 'Unsupported type. Upload PDF or an image.';
      return null;
    };

    // ===== Dropzone events =====
    ['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      dz.classList.add('dragover');
    }));
    ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      dz.classList.remove('dragover');
    }));
    dz.addEventListener('drop', (e) => {
      const file = e.dataTransfer.files?.[0];
      handleFile(file);
    });

    // Choose button triggers file input
    chooseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => handleFile(fileInput.files?.[0]));

    function handleFile(file) {
      resetUI();
      const err = validateFile(file);
      if (err) { showError(err); summarizeBtn.disabled = true; return; }
      chosenFile = file;
      fileName.textContent = file.name;
      summarizeBtn.disabled = false;
    }

    // Length selector styling + state
    lenBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        lenBtns.forEach(b => b.classList.remove('bg-white','shadow'));
        btn.classList.add('bg-white','shadow');
        lengthVal = btn.dataset.val;
      });
    });

    // Copy & Download
    copyBtn.addEventListener('click', async () => {
      if (!summaryOut.textContent) return;
      await navigator.clipboard.writeText(summaryOut.textContent);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => (copyBtn.textContent = 'Copy'), 900);
    });
    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([summaryOut.textContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'summary.txt'; a.click();
      URL.revokeObjectURL(url);
    });

    // Summarize action
    summarizeBtn.addEventListener('click', async () => {
      resetUI();
      const err = validateFile(chosenFile);
      if (err) { showError(err); return; }

      summarizeBtn.disabled = true;
      progressWrap.classList.remove('hidden');
      progressBar.style.width = '25%';
      progressText.textContent = 'Uploading…';

      try {
        const fd = new FormData();
        fd.append('file', chosenFile);
        fd.append('length', lengthVal);

        // NOTE: fetch progress for uploads is not natively supported; using stages instead.
        const res = await fetch(API_URL, { method: 'POST', body: fd });
        progressBar.style.width = '70%';
        progressText.textContent = 'Processing…';

        let data;
        const text = await res.text(); // read once
        try { data = JSON.parse(text); } catch { data = { error: text }; }

        if (!res.ok) {
          const msg = data?.detail || data?.error || `Request failed (${res.status})`;
          throw new Error(typeof msg === 'string' ? msg : JSON.stringify(msg));
        }

        // Success
        progressBar.style.width = '100%';
        progressText.textContent = 'Done';
        summaryOut.textContent = data.summary || '(No summary)';
        resultCard.classList.remove('hidden');

        // Meta (if present)
        const meta = data.meta || {};
        if (meta.title || meta.author || meta.subject) {
          metaOut.classList.remove('hidden');
          mTitle.textContent = meta.title || '-';
          mAuthor.textContent = meta.author || '-';
          mSubject.textContent = meta.subject || '-';
        }
      } catch (e) {
        showError(`Error: ${e.message}`);
      } finally {
        summarizeBtn.disabled = false;
        setTimeout(() => progressWrap.classList.add('hidden'), 600);
        progressBar.style.width = '0%';
      }
    });
  </script>

</body>
</html>